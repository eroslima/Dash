<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NinjaTrader Dashboard - Compact</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e27;
            --bg-card: #1a1f3a;
            --bg-section: #141829;
            --accent: #e94560;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --border: #2d3548;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: auto;
            padding: 8px;
            font-size: 11px;
        }

        /* Tela de Login */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        #login-screen.hidden {
            display: none;
        }

        .login-box {
            background: var(--bg-card);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
        }

        .login-title {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--accent);
        }

        .login-subtitle {
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-input {
            padding: 12px 16px;
            background: var(--bg-section);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .login-button {
            padding: 14px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .login-button:hover {
            background: #d43d54;
        }

        .login-error {
            color: var(--danger);
            font-size: 13px;
            text-align: center;
            padding: 10px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 6px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        #dashboard-container.hidden {
            display: none;
        }


        /* Header com seletor inline */
        .header {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .header-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
            white-space: nowrap;
        }

        .connection-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .connection-badge.connected {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .connection-badge.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            animation: pulse 2s infinite;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Seletor inline */
        .instrument-selector-inline {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .selector-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .selector-checks {
            display: flex;
            gap: 12px;
        }

        .selector-item {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .selector-item input {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        .selector-item label {
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        /* Container de instrumentos */
        .instruments-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        /* Big card por instrumento */
        .instrument-card {
            min-width: 650px;
            max-width: 650px;
            background: var(--bg-card);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .instrument-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
        }

        .instrument-header {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
            min-width: 80px;
        }

        .realtime-section {
            flex: 1;
        }

        /* Se√ß√µes compactas */
        .section {
            background: var(--bg-section);
            border-radius: 6px;
            padding: 8px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-title .toggle-icon {
            font-size: 10px;
            transition: transform 0.2s;
        }

        .section.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .section.collapsed {
            padding: 6px 8px;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section.collapsed .section-title {
            margin-bottom: 0;
            flex-shrink: 0;
        }

        .section.collapsed .settings-compact {
            display: none;
        }

        .section.collapsed .settings-bottom-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            margin: 0;
        }

        /* Esconder highInd e lowInd quando collapsed */
        .section.collapsed #highInd-container-${instrument},
        .section.collapsed #lowInd-container-${instrument},
        .section.collapsed .setting-mini:has(#highInd-container-${instrument}),
        .section.collapsed .setting-mini:has(#lowInd-container-${instrument}) {
            display: none;
        }

        /* Esconder containers por atributo id que contenha highInd ou lowInd */
        .section.collapsed [id*="highInd-container"],
        .section.collapsed [id*="lowInd-container"] {
            display: none;
        }

        .section.collapsed .setting-mini {
            flex-direction: row;
            align-items: center;
            gap: 8px;
        }

        .section.collapsed .setting-mini-label {
            margin: 0;
            white-space: nowrap;
        }

        .section.collapsed .position-mini {
            margin: 0;
        }

        /* Configura√ß√µes compactas */
        .settings-compact {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 6px;
        }

        .settings-bottom-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1.5fr 1.5fr;
            gap: 6px;
        }

        .setting-mini {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .setting-mini-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }

        .setting-mini-input {
            width: 100%;
            padding: 3px 6px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: white;
            font-size: 12px;
        }

        .setting-mini-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .setting-mini-check {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
        }

        .setting-mini-check input {
            width: 12px;
            height: 12px;
        }

        .radio-mini {
            display: flex;
            gap: 3px;
        }

        .radio-mini-item {
            flex: 1;
            padding: 3px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 3px;
            text-align: center;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .radio-mini-item:hover {
            background: rgba(233, 69, 96, 0.2);
        }

        .radio-mini-item.selected {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Dados em tempo real compactos */
        .realtime-compact {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
        }

        .data-mini {
            background: rgba(0,0,0,0.3);
            padding: 4px 6px;
            border-radius: 4px;
        }

        .data-mini-label {
            font-size: 8px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .data-mini-value {
            font-size: 11px;
            font-weight: 700;
        }

        .data-mini-value.positive { color: var(--success); }
        .data-mini-value.negative { color: var(--danger); }

        .position-mini {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 700;
        }

        .position-mini.flat { background: rgba(136,146,176,0.2); color: var(--text-secondary); }
        .position-mini.long { background: rgba(16,185,129,0.2); color: var(--success); }
        .position-mini.short { background: rgba(239,68,68,0.2); color: var(--danger); }

        /* Linha Cond Entry/Exit + WaitChange + WaitStop */
        .cond-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 8px;
            padding: 6px 8px;
            background: rgba(0,0,0,0.25);
            border-radius: 5px;
            border-left: 3px solid var(--border);
            height: 85px; /* Altura fixa para exatamente 4 linhas */
            overflow-y: auto;
            overflow-x: hidden;
        }

        .cond-item {
            display: flex;
            align-items: baseline;
            gap: 8px;
            font-size: 11px;
            line-height: 1.5;
        }

        .cond-value {
            color: var(--text-primary);
            font-size: 11px;
        }

        .cond-item.entry   .cond-value { color: var(--success); }
        .cond-item.change  .cond-value { color: #38bdf8; }
        .cond-item.stop    .cond-value { color: #38bdf8;  }

        /* Tabela de indicadores ultra compacta */
        .indicators-tiny {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .indicators-tiny th {
            padding: 3px 2px;
            text-align: center;
            color: var(--text-secondary);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            text-transform: uppercase;
        }

        .indicators-tiny td {
            padding: 3px 2px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            text-align: center;
        }

        .indicators-tiny tr:hover {
            background: rgba(255,255,255,0.03);
        }

        .indicator-icon {
            font-size: 12px;
        }

        .indicator-up { color: var(--success); }
        .indicator-down { color: var(--danger); }
        .indicator-neutral { color: var(--text-secondary); }

        /* STATE: s√≠mbolo alinhado √† esquerda com largura fixa */
        .state-cell {
            display: flex;
            align-items: baseline;
            gap: 4px;
            white-space: nowrap;
        }
        .state-icon {
            font-family: monospace;
            min-width: 24px;
            display: inline-block;
        }

        /* Tabela ATR */
        .atr-tiny {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .atr-tiny th {
            padding: 3px 2px;
            text-align: center;
            color: var(--text-secondary);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }

        .atr-tiny td {
            padding: 3px 2px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            text-align: center;
        }

        .atr-tiny tr:hover {
            background: rgba(255,255,255,0.03);
        }

        /* Linha ind_stop ‚Äî destaque contrastante */
        tr.row-indstop {
            /* Linha sem borda geral */
        }

        /* Fundo creme e borda dourada apenas nas c√©lulas que n√£o s√£o Trend */
        tr.row-indstop td:not(.trend-cell) {
            background: rgba(250, 240, 180, 0.92);
            color: #1a1a2e;
            font-weight: 700;
            box-shadow: inset 0 0 0 1px rgba(200, 180, 60, 0.6);
        }

        /* Coluna Trend mant√©m fundo escuro */
        tr.row-indstop td.trend-cell {
            background: var(--bg-secondary);
            font-weight: 700;
        }

        /* STATE e ATR dentro da linha ind_stop mant√™m regra original */
        tr.row-indstop td.keep-original {
            font-weight: 600;
        }

        /* Trend ‚Äî colora√ß√£o condicional */
        .trend-red    { color: var(--danger) !important; font-weight: 700; }
        .trend-green  { color: var(--success) !important; font-weight: 700; }
        .trend-yellow { color: var(--warning) !important; font-weight: 700; }

        /* Bot√µes compactos */
        .btn-mini {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .btn-mini.primary {
            background: var(--accent);
            color: white;
        }

        .btn-mini.primary:hover {
            background: #c23852;
        }

        .btn-mini.secondary {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .btn-mini.secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 16px;
            right: 16px;
            padding: 12px 20px;
            background: var(--bg-card);
            border-radius: 6px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.5);
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s;
            font-size: 11px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast.warning { border-left: 3px solid var(--warning); }

        /* Scrollbar customizada */
        ::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }
    </style>
</head>
<body>

    <!-- Tela de Login -->
    <div id="login-screen">
        <div class="login-box">
            <div class="login-title">üîê NinjaTrader Dashboard</div>
            <div class="login-subtitle">Acesso Restrito</div>
            <form class="login-form" onsubmit="return checkPassword(event)">
                <input
                    type="password"
                    id="password-input"
                    class="login-input"
                    placeholder="Digite a senha"
                    autocomplete="off"
                    required
                />
                <button type="submit" class="login-button">Entrar</button>
                <div id="login-error" class="login-error">Senha incorreta. Tente novamente.</div>
            </form>
        </div>
    </div>

    <!-- Dashboard (oculto inicialmente) -->
    <div id="dashboard-container" class="hidden">

    <!-- Header com seletor inline -->
    <div class="header">
        <div class="header-left">
            <div class="header-title">üìä NinjaTrader Dashboard</div>
            <div class="instrument-selector-inline">
                <div class="selector-title">Selecione os instrumentos:</div>
                <div class="selector-checks" id="instrumentSelector"></div>
            </div>
        </div>
        <div class="connection-badge disconnected" id="connectionStatus">
            <div class="status-dot"></div>
            <span>Desconectado</span>
        </div>
    </div>

    <!-- Container de Instrumentos -->
    <div class="instruments-container" id="instrumentsContainer">
        <!-- Cards de instrumentos ser√£o adicionados aqui dinamicamente -->
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Detecta automaticamente o host da p√°gina para conectar ao WebSocket
        const pageHost = window.location.hostname || 'localhost';
        const WS_URL = `ws://${pageHost}:8080`;
        const ALL_INSTRUMENTS = ['ES', 'MES', 'RTY', 'M2K', 'NQ', 'MNQ'];
        const CLOUDFLARE_URL = 'contain-arthritis-islands-voters.trycloudflare.com';

        console.log('üîå WebSocket URL:', WS_URL);

        let ws = null;
        let isConnected = false;
        let selectedInstruments = ['MES', 'ES']; // Padr√£o
        let allSettings = {};
        let originalSettings = {};
        let realtimeDataByInstrument = {};

        const SETTINGS_CONFIG = {
            doNotEntry: { type: 'checkbox', label: 'Do Not Entry' },
            paused: { type: 'checkbox', label: 'Paused' },
            daytrade: { type: 'checkbox', label: 'DayTrade' },
            swingtrade: { type: 'checkbox', label: 'SwingTrade' },
            forceExit: { type: 'checkbox', label: 'Force Exit' },
            bypassPnL: { type: 'checkbox', label: 'BypassPnL' },
            bypassT3: { type: 'checkbox', label: 'BypassT3' },
            enableEarly: { type: 'checkbox', label: 'Early' },
            enableUp: { type: 'checkbox', label: 'Up' },
            enableGAP: { type: 'checkbox', label: 'GAP' },

            longoArq: { type: 'radio', label: 'Tend√™ncia', options: ['-2', '-1', '0', '1', '2'] },

            initial: { type: 'number', label: 'Initial', step: '0.01' },
            newStop: { type: 'number', label: 'NewStop', step: '0.01' },
            valueExitOrder: { type: 'number', label: '$ Exit', step: '0.01' },
            pctExitOrder: { type: 'number', label: '% Exit', step: '0.01' },

            fastOpen: { type: 'integer', label: 'Fast Open' },
            fastClose: { type: 'integer', label: 'Fast Close' },
            fastExitBB: { type: 'integer', label: 'Fast ExitBB' },
            highInd: { type: 'integer', label: 'High Ind' },
            lowInd: { type: 'integer', label: 'Low Ind' }
        };

        window.onload = () => {
            createInstrumentSelector();
            connectWebSocket();
            renderInstruments();
        };

        function createInstrumentSelector() {
            const container = document.getElementById('instrumentSelector');
            ALL_INSTRUMENTS.forEach(inst => {
                const checked = selectedInstruments.includes(inst);
                container.innerHTML += `
                    <div class="selector-item">
                        <input type="checkbox" id="sel-${inst}" ${checked ? 'checked' : ''}
                               onchange="toggleInstrument('${inst}', this.checked)">
                        <label for="sel-${inst}">${inst}</label>
                    </div>
                `;
            });
        }

        function toggleInstrument(instrument, show) {
            if (show && !selectedInstruments.includes(instrument)) {
                selectedInstruments.push(instrument);
            } else if (!show) {
                selectedInstruments = selectedInstruments.filter(i => i !== instrument);
            }
            renderInstruments();
        }

        function renderInstruments() {
            const container = document.getElementById('instrumentsContainer');
            container.innerHTML = '';

            selectedInstruments.forEach(inst => {
                const card = createInstrumentCard(inst);
                container.appendChild(card);
            });
        }

        function createInstrumentCard(instrument) {
            const card = document.createElement('div');
            card.className = 'instrument-card';
            card.id = `card-${instrument}`;

            card.innerHTML = `
                <!-- Header com nome e dados em tempo real lado a lado -->
                <div class="instrument-header-row">
                    <div class="instrument-header">${instrument}</div>
                    <div class="realtime-section">
                        <div class="section-title" style="margin-bottom:4px">üìà Tempo Real</div>
                        <div class="realtime-compact" id="realtime-${instrument}">
                            <div class="data-mini">
                                <div class="data-mini-label">PnL</div>
                                <div class="data-mini-value" id="pnl-${instrument}">$0.00</div>
                            </div>
                            <div class="data-mini">
                                <div class="data-mini-label">Avg/Stop</div>
                                <div class="data-mini-value" id="prices-${instrument}">- / -</div>
                            </div>
                            <div class="data-mini">
                                <div class="data-mini-label">Risco</div>
                                <div class="data-mini-value" id="risk-${instrument}">$0.00</div>
                            </div>
                            <div class="data-mini">
                                <div class="data-mini-label">Bid/Ask</div>
                                <div class="data-mini-value" id="bidask-${instrument}">- / -</div>
                            </div>
                            <div class="data-mini">
                                <div class="data-mini-label">Status</div>
                                <div class="data-mini-value" id="status-${instrument}" style="font-size:9px">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configura√ß√µes -->
                <div class="section" id="settings-section-${instrument}">
                    <div class="section-title" onclick="toggleSettingsSection('${instrument}')">
                        <span class="toggle-icon">‚ñº</span>
                        <span>‚öôÔ∏è Configura√ß√µes</span>
                    </div>
                    <div class="settings-compact" id="settings-${instrument}"></div>
                    <div class="settings-bottom-row">
                        <div class="setting-mini">
                            <div class="setting-mini-label">Posi√ß√£o</div>
                            <div style="padding-top:3px"><span class="position-mini flat" id="pos-${instrument}">FLAT</span></div>
                        </div>
                        <div class="setting-mini" id="highInd-container-${instrument}"></div>
                        <div class="setting-mini" id="lowInd-container-${instrument}"></div>
                        <button class="btn-mini primary" onclick="saveSettings('${instrument}')">üíæ Salvar</button>
                        <button class="btn-mini secondary" onclick="reloadSettings('${instrument}')">üîÑ Recarregar</button>
                    </div>
                </div>

                <!-- Indicadores -->
                <div class="section">
                    <div class="section-title">üìä Indicadores T√©cnicos</div>
                    <div class="cond-row">
                        <div class="cond-item entry">
                            <span class="cond-value" id="condEntry-${instrument}">-</span>
                        </div>
                        <div class="cond-item change">
                            <span class="cond-value" id="waitChange-${instrument}">-</span>
                        </div>
                        <div class="cond-item stop">
                            <span class="cond-value" id="waitStop-${instrument}">-</span>
                        </div>
                    </div>
                    <div style="overflow-x:auto">
                        <table class="indicators-tiny" id="ind-${instrument}">
                            <thead>
                                <tr>
                                    <th>K</th>
                                    <th>Per</th>
                                    <th>P</th>
                                    <th>K</th>
                                    <th>D</th>
                                    <th style="text-align:left">State</th>
                                    <th>M</th>
                                    <th>P</th>
                                    <th>M</th>
                                    <th>IG</th>
                                    <th>1‚Üík</th>
                                    <th>k‚Üí5</th>
                                    <th style="text-align:left">Trend</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="13" style="color:var(--text-secondary)">Aguardando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ATR -->
                <div class="section">
                    <div class="section-title">üìà Last Diff | Avg Diff | ATR | Sup &amp; Res</div>
                    <div style="overflow-x:auto">
                        <table class="atr-tiny" id="atr-${instrument}">
                            <thead>
                                <tr>
                                    <th>K</th>
                                    <th>A0</th>
                                    <th>A1</th>
                                    <th>A2</th>
                                    <th>M0</th>
                                    <th>M1</th>
                                    <th>M2</th>
                                    <th>ATR</th>
                                    <th>S/R</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="9" style="color:var(--text-secondary)">Aguardando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            return card;
        }

        function connectWebSocket() {
            try {
                ws = new WebSocket(WS_URL);

                ws.onopen = () => {
                    isConnected = true;
                    updateConnectionStatus(true);
                    showToast('Conectado ao NinjaTrader!', 'success');
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };

                ws.onclose = () => {
                    isConnected = false;
                    updateConnectionStatus(false);
                    setTimeout(connectWebSocket, 2000);
                };
            } catch (error) {
                console.error('Erro ao conectar:', error);
                updateConnectionStatus(false);
            }
        }

        function handleMessage(data) {
            switch (data.type) {
                case 'connected':
                    if (data.settings) {
                        allSettings = data.settings;
                        originalSettings = JSON.parse(JSON.stringify(data.settings));
                        selectedInstruments.forEach(inst => renderSettings(inst));
                    }
                    break;

                case 'strategy_data':
                    if (data.data && data.data.Instrument) {
                        const instrumentName = data.data.Instrument.split(' ')[0];
                        realtimeDataByInstrument[instrumentName] = data.data;

                        if (selectedInstruments.includes(instrumentName)) {
                            updateRealtimeData(instrumentName, data.data);
                            updateIndicators(instrumentName, data.data);
                        }
                    }
                    break;

                case 'settings_updated':
                    if (data.settings) {
                        allSettings[data.instrument] = data.settings;
                        if (selectedInstruments.includes(data.instrument)) {
                            renderSettings(data.instrument);
                        }
                        showToast(`${data.instrument} salvo!`, 'success');
                    }
                    break;

                case 'pong':
                    break;
            }
        }

        function renderSettings(instrument) {
            const container = document.getElementById(`settings-${instrument}`);
            const highIndContainer = document.getElementById(`highInd-container-${instrument}`);
            const lowIndContainer = document.getElementById(`lowInd-container-${instrument}`);

            if (!container) return;

            const settings = allSettings[instrument] || {};
            let html = '';

            for (const [key, config] of Object.entries(SETTINGS_CONFIG)) {
                // Skip highInd e lowInd pois v√£o na linha de baixo
                if (key === 'highInd' || key === 'lowInd') continue;

                const value = settings[key] ?? '';

                if (config.type === 'checkbox') {
                    const checked = value == 1;
                    let statusText  = checked ? 'On' : 'Off';
                    let statusStyle = '';
                    if (key === 'doNotEntry') {
                        statusText  = checked ? 'Blocked' : 'Off';
                        statusStyle = checked ? ' style="color:var(--danger);font-weight:700"' : '';
                    } else if (key === 'paused') {
                        statusText  = checked ? 'Paused'  : 'Off';
                        statusStyle = checked ? ' style="color:var(--warning);font-weight:700"' : '';
                    }
                    html += `
                        <div class="setting-mini">
                            <div class="setting-mini-label">${config.label}</div>
                            <div class="setting-mini-check">
                                <input type="checkbox" ${checked ? 'checked' : ''}
                                       onchange="updateSetting('${instrument}', '${key}', this.checked ? 1 : 0)">
                                <span${statusStyle}>${statusText}</span>
                            </div>
                        </div>
                    `;
                } else if (config.type === 'radio') {
                    html += `
                        <div class="setting-mini" style="grid-column: span 2">
                            <div class="setting-mini-label">${config.label}</div>
                            <div class="radio-mini">
                                ${config.options.map(opt => `
                                    <div class="radio-mini-item ${value == opt ? 'selected' : ''}"
                                         onclick="updateSetting('${instrument}', '${key}', '${opt}')">
                                        ${opt}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    const step = config.step || '1';
                    html += `
                        <div class="setting-mini">
                            <div class="setting-mini-label">${config.label}</div>
                            <input type="number" class="setting-mini-input"
                                   value="${value}" step="${step}"
                                   onchange="updateSetting('${instrument}', '${key}', ${config.type === 'number' ? 'parseFloat(this.value)' : 'parseInt(this.value)'})">
                        </div>
                    `;
                }
            }

            container.innerHTML = html;

            // Renderiza High Ind e Low Ind na linha de baixo
            const highValue = settings['highInd'] ?? '';
            const lowValue = settings['lowInd'] ?? '';

            if (highIndContainer) {
                highIndContainer.innerHTML = `
                    <div class="setting-mini-label">High Ind</div>
                    <input type="number" class="setting-mini-input"
                           value="${highValue}" step="1"
                           onchange="updateSetting('${instrument}', 'highInd', parseInt(this.value))">
                `;
            }

            if (lowIndContainer) {
                lowIndContainer.innerHTML = `
                    <div class="setting-mini-label">Low Ind</div>
                    <input type="number" class="setting-mini-input"
                           value="${lowValue}" step="1"
                           onchange="updateSetting('${instrument}', 'lowInd', parseInt(this.value))">
                `;
            }
        }

        function updateSetting(instrument, key, value) {
            if (!allSettings[instrument]) {
                allSettings[instrument] = {};
            }
            allSettings[instrument][key] = value;
            renderSettings(instrument);
        }

        function saveSettings(instrument) {
            if (!isConnected) {
                showToast('N√£o conectado', 'error');
                return;
            }

            const message = {
                type: 'update_settings',
                instrument: instrument,
                settings: allSettings[instrument]
            };

            ws.send(JSON.stringify(message));
        }

        function toggleSettingsSection(instrument) {
            const section = document.getElementById(`settings-section-${instrument}`);
            if (section) {
                section.classList.toggle('collapsed');
            }
        }

        function reloadSettings(instrument) {
            allSettings[instrument] = JSON.parse(JSON.stringify(originalSettings[instrument] || {}));
            renderSettings(instrument);
            showToast('Recarregado', 'success');
        }

        function updateRealtimeData(instrument, data) {
            const num = (v) => Number(v) || 0;
            const fix2 = (v) => num(v).toFixed(2);

            // Posi√ß√£o
            const posEl = document.getElementById(`pos-${instrument}`);
            if (posEl) {
                if (data.PosL) {
                    posEl.className = 'position-mini long';
                    posEl.textContent = 'LONG';
                } else if (data.PosS) {
                    posEl.className = 'position-mini short';
                    posEl.textContent = 'SHORT';
                } else {
                    posEl.className = 'position-mini flat';
                    posEl.textContent = 'FLAT';
                }
            }

            // PnL
            const pnlEl = document.getElementById(`pnl-${instrument}`);
            if (pnlEl) {
                const pnl = num(data.PnLDollars);
                pnlEl.textContent = '$' + pnl.toFixed(2);
                pnlEl.className = 'data-mini-value';
                if (pnl > 0) pnlEl.classList.add('positive');
                else if (pnl < 0) pnlEl.classList.add('negative');
            }

            // Prices
            const pricesEl = document.getElementById(`prices-${instrument}`);
            if (pricesEl) {
                pricesEl.textContent = fix2(data.AvgPrice) + ' / ' + fix2(data.StopPrice);
            }

            // Risk
            const riskEl = document.getElementById(`risk-${instrument}`);
            if (riskEl) {
                riskEl.textContent = '$' + fix2(data.RiskInCash);
            }

            // Bid/Ask
            const bidaskEl = document.getElementById(`bidask-${instrument}`);
            if (bidaskEl) {
                bidaskEl.textContent = fix2(data.Bid) + ' / ' + fix2(data.Ask);
            }

            // Status
            const statusEl = document.getElementById(`status-${instrument}`);
            if (statusEl) {
                statusEl.textContent = data.FinalCond || '-';
            }
        }

        function updateIndicators(instrument, data) {
            if (!data.Indicators || data.Indicators.length === 0) return;

            const indTable = document.getElementById(`ind-${instrument}`);
            const atrTable = document.getElementById(`atr-${instrument}`);

            if (!indTable || !atrTable) return;

            // Atualiza Cond Entry/Exit, WaitChange, WaitStop
            const condEl  = document.getElementById('condEntry-'  + instrument);
            const wChgEl  = document.getElementById('waitChange-' + instrument);
            const wStpEl  = document.getElementById('waitStop-'   + instrument);
            if (condEl)  {
                condEl.textContent  = data.CondEntry  || '-';
                condEl.style.color  = (data.doNotEntry == 1) ? 'var(--danger)' : '';
            }
            if (wChgEl)  wChgEl.textContent  = data.WaitChange || '-';
            if (wStpEl)  wStpEl.textContent  = data.WaitStop   || '-';

            let indHTML = '';
            let atrHTML = '';

            // Pega tend√™ncia (longoArq) e fastOpen dos dados principais
            const longoArq = parseInt(data.LongoArq) || 0;
            const fastOpen = parseInt(data.FastOpen) || 0;

            // IndStop do JSON principal
            const indStop = parseInt(data.IndStop) || 0;

            data.Indicators.forEach(ind => {
                const isStop   = (ind.k === indStop);
                const trClass  = isStop ? ' class="row-indstop"' : '';
                const dsmClass = ind.Dir > 0 ? 'indicator-up' : ind.Dir < 0 ? 'indicator-down' : 'indicator-neutral';

                // Colora√ß√£o Trend ‚Äî usa fastOpen como fallback quando longoArq == 0 (igual √† l√≥gica S/R)
                let trendClass = '';
                const t = (ind.Trend || '').trim();
                const tendencia = longoArq !== 0 ? longoArq : fastOpen; // fallback
                const hasNOpFO = /.{1,2} Op FO/.test(t);
                const hasNOp   = /.{1,2} Op/.test(t);
                const hasIG    = /& IG/.test(t);
                if      (hasNOpFO)                                                   trendClass = 'trend-yellow';
                else if (tendencia > 0 && t.startsWith('Short') && hasNOp)           trendClass = 'trend-red';
                else if (tendencia < 0 && t.startsWith('Long')  && hasNOp)           trendClass = 'trend-red';
                else if (tendencia > 0 && t.startsWith('Long')  && hasIG && !hasNOp) trendClass = 'trend-green';
                else if (tendencia < 0 && t.startsWith('Short') && hasIG && !hasNOp) trendClass = 'trend-green';

                // Tabela de indicadores
                indHTML += `
                    <tr${trClass}>
                        <td><strong>${ind.k}</strong></td>
                        <td>${ind.Period || '-'}</td>
                        <td>${ind.Pos}</td>
                        <td>${parseFloat(ind.DsmK).toFixed(0)}</td>
                        <td>${parseFloat(ind.DsmD).toFixed(0)}</td>
                        <td class="${dsmClass} keep-original" style="text-align:left; font-size:12px"><div class="state-cell"><span class="state-icon">${ind.DsmIcon}</span><span>${ind.State}</span></div></td>
                        <td class="indicator-icon">${ind.MacdIcon}</td>
                        <td class="indicator-icon">${ind.PsarIcon}</td>
                        <td class="indicator-icon">${ind.MomIcon}</td>
                        <td>${ind.IG}</td>
                        <td>${ind.k >= 1 ? parseFloat(ind.OpD1k).toFixed(1) : '-'}</td>
                        <td>${ind.k >= 1 ? parseFloat(ind.OpDk5).toFixed(1) : '-'}</td>
                        <td class="${trendClass} trend-cell" style="text-align:left; font-size:12px">${ind.Trend}</td>
                    </tr>
                `;

                // Tabela ATR com S/R condicional baseado em longoArq e fastOpen
                const atrClass = ind.ATR === 'Fast' ? 'indicator-up' : ind.ATR === 'Slow' ? 'indicator-down' : 'indicator-neutral';

                let srValue = '';
                if (longoArq > 0 || (longoArq === 0 && fastOpen > 0)) {
                    srValue = ind.Support > 0 ? parseFloat(ind.Support).toFixed(2) : '-';
                } else if (longoArq < 0 || (longoArq === 0 && fastOpen < 0)) {
                    srValue = ind.Resistance > 0 ? parseFloat(ind.Resistance).toFixed(2) : '-';
                } else if (longoArq === 0 && fastOpen === 0) {
                    const sup = ind.Support > 0 ? parseFloat(ind.Support).toFixed(2) : '-';
                    const res = ind.Resistance > 0 ? parseFloat(ind.Resistance).toFixed(2) : '-';
                    srValue = sup + '/' + res;
                }

                atrHTML += `
                    <tr${trClass}>
                        <td><strong>${ind.k}</strong></td>
                        <td>${parseFloat(ind.DiffAct0).toFixed(1)}</td>
                        <td>${parseFloat(ind.DiffAct1).toFixed(1)}</td>
                        <td>${parseFloat(ind.DiffAct2).toFixed(1)}</td>
                        <td>${parseFloat(ind.DiffMed0).toFixed(1)}</td>
                        <td>${parseFloat(ind.DiffMed1).toFixed(1)}</td>
                        <td>${parseFloat(ind.DiffMed2).toFixed(1)}</td>
                        <td class="${atrClass} keep-original"><strong>${ind.ATR}</strong></td>
                        <td>${srValue}</td>
                    </tr>
                `;
            });

            indTable.querySelector('tbody').innerHTML = indHTML;
            atrTable.querySelector('tbody').innerHTML = atrHTML;
        }

        function updateConnectionStatus(connected) {
            const badge = document.getElementById('connectionStatus');
            if (connected) {
                badge.className = 'connection-badge connected';
                badge.innerHTML = '<div class="status-dot"></div><span>Conectado</span>';
            } else {
                badge.className = 'connection-badge disconnected';
                badge.innerHTML = '<div class="status-dot"></div><span>Desconectado</span>';
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;

            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        setInterval(() => {
            if (isConnected && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ping' }));
            }
        }, 30000);

        // ========== AUTENTICA√á√ÉO ==========
        // Senha padr√£o: "abc123"
        // Para alterar: gere o hash SHA-256 da sua senha em https://emn178.github.io/online-tools/sha256.html
        const PASSWORD_HASH = '31be89d6f8fa7c5d86dd2d68372ee6a57d3122ce430c40dd5a051682f4a19fc2'; // SHA-256 de "abc123"

        // Fun√ß√£o simples de hash SHA-256
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        async function checkPassword(event) {
            event.preventDefault();
            const input = document.getElementById('password-input');
            const error = document.getElementById('login-error');

            try {
                const hash = await sha256(input.value);

                if (hash === PASSWORD_HASH) {
                    sessionStorage.setItem('authenticated', 'true');
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('dashboard-container').classList.remove('hidden');
                } else {
                    error.classList.add('show');
                    input.value = '';
                    input.focus();
                    setTimeout(() => error.classList.remove('show'), 3000);
                }
            } catch (e) {
                console.error('Erro na autentica√ß√£o:', e);
            }

            return false;
        }

        // Verificar se j√° est√° autenticado ao carregar
        window.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('authenticated') === 'true') {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard-container').classList.remove('hidden');
            } else {
                const passwordInput = document.getElementById('password-input');
                if (passwordInput) {
                    passwordInput.focus();
                }
            }
        });

    </script>
    </div>
</body>
</html>
